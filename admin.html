<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exemple de Dropzone.js</title>
    <link rel="stylesheet" href="./assets/css/style.css" />
    <script src="dropzone/dropzone.min.js"></script>
    <link rel="stylesheet" href="dropzone/dropzone.min.css" />
  </head>
  <body>
    <header>
      <div class="avatar">
        <img src="./assets/images/avatar.png" alt="Avatar" class="avatarImg" />
        <div>
          <h1>Bastien Courseaux</h1>
          <p>Mes cours de mathématiques</p>
        </div>
        <a href="./index.html"
          ><img src="./assets/icones/sync.svg" alt="retour" class="log"
        /></a>
      </div>
    </header>
    <main>
      <!-- Dropzone -->
      <div id="dropzonesContainer">
        <div class="dropzone" id="dropzone1">
          <div class="dz-message">
            Glissez-déposez les fichiers ici ou cliquez pour les sélectionner.
          </div>
        </div>
        <ul id="fileList1"></ul>
        <div class="dropzone" id="dropzone2">
          <div class="dz-message">
            Glissez-déposez les fichiers ici ou cliquez pour les sélectionner.
          </div>
        </div>
        <ul id="fileList2"></ul>
        <div class="dropzone" id="dropzone3">
          <div class="dz-message">
            Glissez-déposez les fichiers ici ou cliquez pour les sélectionner.
          </div>
        </div>
        <ul id="fileList3"></ul>
        <div class="dropzone" id="dropzone4">
          <div class="dz-message">
            Glissez-déposez les fichiers ici ou cliquez pour les sélectionner.
          </div>
        </div>
        <ul id="fileList4"></ul>
      </div>
    </main>
    <script>
      // Fonction pour initialiser Dropzone pour chaque élément avec la classe "dropzone"
      function initDropzone(dropzoneId, fileListId, destinationFolder) {
        return new Dropzone("#" + dropzoneId, {
          url: "./php/upload.php",
          acceptedFiles: ".pdf",
          maxFilesize: 5,
          addRemoveLinks: true,
          dictRemoveFile: "Annuler",
          init: function () {
            this.on("sending", function (file, xhr, formData) {
              formData.append("folder", destinationFolder); // Ajoute le paramètre "folder" à la requête
            });
            this.on("success", function (file, response) {
              fetchFileList(fileListId, destinationFolder);
            });
            this.on("removedfile", function (file) {
              deleteFile(file.name, fileListId, destinationFolder);
            });
          },
        });
      }

      // Fonction pour récupérer la liste des fichiers PDF disponibles depuis le serveur
      function fetchFileList(fileListId, destinationFolder) {
        fetch("./php/get_file_list.php?folder=" + destinationFolder)
          .then((response) => response.json())
          .then((data) => {
            const fileListElement = document.getElementById(fileListId);
            fileListElement.innerHTML = "";

            data.forEach((file) => {
              const listItem = document.createElement("li");
              const link = document.createElement("a");
              link.href = "uploads/" + destinationFolder + "/" + file;
              link.textContent = file;
              link.style.marginRight = "10px";
              listItem.appendChild(link);

              // Icone suppression
              const deleteIcon = document.createElement("img");
              deleteIcon.src = "./assets/icones/iconDelete.svg";
              deleteIcon.alt = "Supprimer";
              deleteIcon.classList.add("delete-icon");
              deleteIcon.dataset.fileName = file; // On utilise le nom du fichier comme attribut personnalisé
              listItem.appendChild(deleteIcon);
              fileListElement.appendChild(listItem);
            });
          });
      }

      // Fonction pour supprimer un fichier (implémentez cette fonction pour effectuer la suppression côté serveur)
      function deleteFile(fileName, fileListId, destinationFolder) {
        // Ici, vous pouvez effectuer une requête pour supprimer le fichier côté serveur
        fetch("./php/delete_file.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            fileName: fileName,
            folder: destinationFolder,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            // Recharger la liste des fichiers après la suppression
            fetchFileList(fileListId, destinationFolder);
          });
      }

      // Initialiser toutes les dropzones avec la classe "dropzone" et leurs listes de fichiers respectives
      const dropzones = [
        {
          id: "dropzone1",
          fileListId: "fileList1",
          destinationFolder: "uploads1",
        },
        {
          id: "dropzone2",
          fileListId: "fileList2",
          destinationFolder: "uploads2",
        },
        {
          id: "dropzone3",
          fileListId: "fileList3",
          destinationFolder: "uploads3",
        },
        {
          id: "dropzone4",
          fileListId: "fileList4",
          destinationFolder: "uploads4",
        },
      ];

      dropzones.forEach((dropzone) => {
        initDropzone(
          dropzone.id,
          dropzone.fileListId,
          dropzone.destinationFolder
        );
        fetchFileList(dropzone.fileListId, dropzone.destinationFolder);
      });

      // Ajouter l'écouteur d'événement pour les boutons de suppression
      document.addEventListener("click", (event) => {
        if (event.target.tagName === "IMG") {
          const fileName = event.target.dataset.fileName;
          const fileListId = event.target.closest("ul").id;
          const destinationFolder = dropzones.find(
            (dropzone) => dropzone.fileListId === fileListId
          ).destinationFolder;
          deleteFile(fileName, fileListId, destinationFolder);
        }
      });
    </script>
  </body>
</html>
